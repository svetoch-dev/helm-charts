{{- $releasename := .Release.Name }}
{{- range $name, $alert := .Values.PrometheusAlerts }}
{{- $namespace := $.Release.Namespace }}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $releasename }}-{{ $name }}-alerts
  labels:
{{- include "prometheus-rules.labels" $ | nindent 4 }}
    {{- toYaml $alert.selector | nindent 4 }}
{{- $tm := "30m" }}
spec:
  groups:
  {{- if not .AbsentMetricCritical.disabled }}
    - name: "AbsentMetricCritical"
      {{- if .AbsentMetricCritical.interval }}
      interval: {{ .AbsentMetricCritical.interval }}
      {{- end }}
      rules:
        {{- range $absentMetricRuleName, $absentMetricRule := .AbsentMetricCritical.rules }}
        {{- if not $absentMetricRule.disabled}}
        {{- $parts := split "{" $absentMetricRuleName }}
        - alert: absent_{{$parts._0}}
          expr: absent({{$absentMetricRuleName}})
          for: {{$tm}}
          labels:
            env: {{ $alert.env }}
            severity: critical
            namespace: {{ $namespace }}
            team: {{ $alert.team }}
          annotations:
            summary: |
              Critical metrics is Absent {{ $name }} {{ $absentMetricRuleName }}
            description: |
              There are no metric {{$absentMetricRuleName}} from {{$absentMetricRule.source}} in {{ $name }}.
              Check the source {{$absentMetricRule.source}} instance and scrape process
        {{- end }}
        {{- end }}
  {{- end }}
  {{- if .CriticalMetric }}
    - name: CriticalMetric
      {{- if .CriticalMetric.interval }}
      interval: {{ .CriticalMetric.interval }}
      {{- end }}
      rules:
        {{- range $critMetricRuleName, $critMetricRule := .CriticalMetric.rules }}
        {{- if not $critMetricRule.disabled}}
        - alert: {{ $critMetricRuleName }}
          expr: |
            {{- $critMetricRule.expr | nindent 12}}
          for: {{ $critMetricRule.for }}
          {{- with $critMetricRule.keep_firing_for }}
          keep_firing_for: {{ . }}
          {{- end }}
          labels:
            env: {{ $alert.env }}
            severity: critical
            team: {{ $alert.team }}
            namespace: {{ $namespace }}
          annotations:
            summary: |
              {{- $critMetricRule.summary | default $critMetricRuleName | nindent 14  }}
            description: |
              {{- $critMetricRule.description | nindent 14 }}
        {{- end }}
        {{- end }}
  {{- end }}
  {{- if .WarningMetric }}
    - name: WarningMetric
      {{- if .WarningMetric.interval }}
      interval: {{ .WarningMetric.interval }}
      {{- end }}
      rules:
        {{- range $warnMetricRuleName, $warnMetricRule := .WarningMetric.rules }}
        {{- if not $warnMetricRule.disabled}}
        - alert: {{ $warnMetricRuleName }}
          expr: |
            {{- $warnMetricRule.expr | nindent 12}}
          for: {{ $warnMetricRule.for }}
          {{- with $warnMetricRule.keep_firing_for }}
          keep_firing_for: {{ . }}
          {{- end }}
          labels:
            env: {{ $alert.env }}
            severity: medium
            team: {{ $alert.team }}
            namespace: {{ $namespace }}
          annotations:
            summary: |
              {{- $warnMetricRule.summary | default $warnMetricRuleName | nindent 14  }}
            description: |
              {{- $warnMetricRule.description | nindent 14 }}
        {{- end }}
        {{- end }}
  {{- end }}
{{- end }}
