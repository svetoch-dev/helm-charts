{{- range $name, $ds := .Values.datasources }}
{{- $tplName := tpl $name $ -}}
{{- if $ds.enabled }}
{{- if eq $tplName "loki-tpl" }}
{{- range $tplEnvName, $envDomain := $ds.externalEnvs }}
{{- $envName := tpl $tplEnvName $ -}}

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  labels:
    {{- include "grafana-datasources.labels" $ | nindent 4 }}
  name: {{ $envName }}
spec:
  {{- with $ds.selector }}
  instanceSelector:
    matchLabels:
      {{- toYaml . | nindent 6 }}
  {{- end }}
  resyncPeriod: {{ $ds.resyncPeriod | default "30s" }}
  {{- if $ds.allowCrossNamespaceImport }}
  allowCrossNamespaceImport: {{ $ds.allowCrossNamespaceImport }}
  {{- end }}
  uid: {{ $envName }}
  {{- with $ds.datasource }}
  datasource:
    name: {{ $envName }}
    url: {{ tpl $envDomain $ }}
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.plugins }}
  plugins:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.valuesFrom }}
  valuesFrom:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}

{{- end }}
{{- else }}

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  labels:
    {{- include "grafana-datasources.labels" $ | nindent 4 }}
  name: {{ $tplName }}
spec:
  {{- with $ds.selector }}
  instanceSelector:
    matchLabels:
      {{- toYaml . | nindent 6 }}
  {{- end }}
  resyncPeriod: {{ $ds.resyncPeriod | default "30s" }}
  {{- if $ds.allowCrossNamespaceImport }}
  allowCrossNamespaceImport: {{ $ds.allowCrossNamespaceImport }}
  {{- end }}
  {{- with $ds.uid }}
  uid: {{ tpl . $ }}
  {{- end }}
  {{- with $ds.datasource }}
  datasource:
    name: {{ $tplName }}
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.plugins }}
  plugins:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.valuesFrom }}
  valuesFrom:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}

{{- end }}
{{- end }}
{{- end }}
