{{- range $name, $ds_obj := .Values.datasources }}
{{- if $ds_obj.enabled }}
{{- $dsName := tpl $name $ -}}

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  labels:
    {{- include "grafana-datasources.labels" $ | nindent 4 }}
  name: {{ $dsName }}
spec:
  {{- with $ds_obj.selector }}
  instanceSelector:
    matchLabels:
      {{- toYaml . | nindent 6 }}
  {{- end }}
  resyncPeriod: {{ $ds_obj.resyncPeriod | default "30s" }}
  {{- if $ds_obj.allowCrossNamespaceImport }}
  allowCrossNamespaceImport: {{ $ds_obj.allowCrossNamespaceImport }}
  {{- end }}
  {{- with $ds_obj.uid }}
  uid: {{ tpl . $ }}
  {{- end }}
  {{- with $ds_obj.datasource }}
  datasource:
    name: {{ $dsName }}
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds_obj.plugins }}
  plugins:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds_obj.valuesFrom }}
  valuesFrom:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}

{{- end }}
{{- end }}
