{{- range $name, $ds := .Values.datasources }}
{{- if $ds.enabled }
{{- if ({{ tpl $name $ }}) eq "loki-tpl" }}

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  labels:
    {{- include "grafana-datasources.labels" $ | nindent 4 }}
  name: {{ tpl $name $ }}
spec:
  {{- with $ds.selector }}
  instanceSelector:
    matchLabels:
      {{- toYaml . | nindent 6 }}
  {{- end }}
  resyncPeriod: {{ $ds.resyncPeriod | default "30s" }}
  {{- if $ds.allowCrossNamespaceImport }}
  allowCrossNamespaceImport: {{ $ds.allowCrossNamespaceImport }}
  {{- end }}
  {{- with $ds.uid }}
  uid: {{ tpl . $ }}
  {{- end }}
  {{- with $ds.datasource }}
  datasource:
    name: {{ tpl $name $ }}
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.plugins }}
  plugins:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
  {{- with $ds.valuesFrom }}
  valuesFrom:
  {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
